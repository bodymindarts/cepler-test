jobs:
- name: staging
  serial: true
  plan:
  - { get: staging, trigger: true }
  - task: execute
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: staging
        path: repo
      outputs:
      - name: repo
      run:
        dir: repo
        path: ls
        args:
          - "-al"
  - task: record-state
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: cepler
        args: ["record", "-e", "staging"]
        dir: repo
  - task: prepare-push
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: git
        args: ["reset", "--hard", "HEAD"]
        dir: repo
  - in_parallel:
    - put: repo
      params:
        repository: repo
        rebase: true
    - put: staging-branch
      params:
        repository: repo

- name: testflight
  serial: true
  plan:
  - { get: testflight, trigger: true }
  - task: execute
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: testflight
        path: repo
      outputs:
      - name: repo
      run:
        dir: repo
        path: ls
        args:
          - "-al"
  - task: record-state
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: cepler
        args: ["record", "-e", "testflight"]
        dir: repo
  - task: prepare-push
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bodymindarts/cepler
          tag: latest
      inputs:
      - name: repo
      outputs:
      - name: repo
      run:
        path: git
        args: ["reset", "--hard", "HEAD"]
        dir: repo
  - in_parallel:
    - put: repo
      params:
        repository: repo
        rebase: true
    - put: testflight-branch
      params:
        repository: repo

resources:
- name: staging
  type: cepler
  source:
    uri: git@github.com:bodymindarts/cepler-test
    branch: main
    private_key: ((github.private_key))
    environment: staging

- name: staging-branch
  type: git
  source:
    uri: git@github.com:bodymindarts/cepler-test
    branch: staging
    private_key: ((github.private_key))
    environment: staging-branch

- name: testflight
  type: cepler
  source:
    uri: git@github.com:bodymindarts/cepler-test
    branch: main
    private_key: ((github.private_key))
    environment: testflight

- name: testflight-branch
  type: git
  source:
    uri: git@github.com:bodymindarts/cepler-test
    branch: testflight
    private_key: ((github.private_key))
    environment: testflight-branch

- name: repo
  type: git
  source:
    uri: git@github.com:bodymindarts/cepler-test
    branch: main
    private_key: ((github.private_key))
    environment: repo

resource_types:
- name: cepler
  type: registry-image
  source:
    repository: bodymindarts/cepler
    tag: latest

